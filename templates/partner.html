<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title  id="title">Partnership Page</title>
    <!-- Include Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS for styling -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- Include custom CSS -->
    <style>
        body {
            height: 100vh;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
        }
           /* Adjust font size for mobile view */
           @media (max-width: 576px) {
            h2 {
                font-size: 36px;
            }
            p {
                font-size: 20px;
            }
        }
        /* Add other custom styles here */
    </style>
</head>
<body>
    <div id="nav-here"></div><script src="backend/nav-content.js"></script>
    <div class="container mt-5">
        <h1 class="mb-4">Partner With Us</h1>
        <div class="row mb-5">
            <div class="col-lg-6">
                <form id="partnership-form">
                    <div class="form-group">
                        <label for="amount">Amount</label>
                        <input type="text" class="form-control" id="amount" name="amount" required>
                    </div>
                    <div class="form-group">
                        <label for="fullname">Full Name</label>
                        <input type="text" class="form-control" id="fullname" name="fullname" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                    </div>
                    <button type="button" id="pay-btn" class="btn btn-primary mt-3 mb-3">
                        <i class="fas fa-credit-card"></i> Pay Now
                    </button>

                </form>            
            </div>

            <div class="col-lg-6">
                <!-- Hero Image -->
                <div class="hero-image text-center sticky-top" style="background-color: #8d949a; ">
                    <img src="uploads/flier.jpg" alt="Flier Image" class="img-fluid">
                </div>
            </div>
        </div>

    </div>
    <!-- Footer -->
    <footer class="bg-dark text-white text-center py-3 d-md-none d-lg-block">
        <p>&copy; 2023 Workers of Miracles Retreat. All rights reserved.</p>
    </footer>
   <!-- Include jQuery and Bootstrap JS -->
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
   <script src="https://js.paystack.co/v1/inline.js"></script>

    <script>
        // Replace with your actual Paystack public key
        //const paystackPublicKey = 'YOUR_PAYSTACK_PUBLIC_KEY';

        $(document).ready(function() {
        $('#pay-btn').click(function() {
            const fullname = $('#fullname').val();
            const email = $('#email').val();
            const amount = $('#amount').val();
            
            payWithPaystack(fullname,email,amount);
            
        });



            // Function to handle the payment process using Paystack
            function payWithPaystack(verify_transaction_id, email, total_amount) {
                const amount  =  total_amount;
                console.log('paywithpaystack');
                const platformId = 1;

                // Function to fetch the public key and currency from get_public_key.php
                function fetchPublicKey(platformId) {
                    return fetch(`backend/get_public_key.php`)
                    .then((response) => {
                        if (!response.ok) {
                        throw new Error("Network response was not ok");
                        }
                        return response.json(); // Return response as JSON
                    })
                    .then((data) => {
                        // Return the fetched public key and currency
                        return {
                        publicKey: data.public_key,
                        currency: data.currency,
                        };
                    })
                    .catch((error) => {
                        console.error("Error fetching public key:", error);
                        throw error; // Rethrow the error to be handled in the main function
                    });
                }

            // Fetch the public key and currency using fetchPublicKey function
            fetchPublicKey()
                .then((response) => {
                const {publicKey, currency } = response;
                // Use the fetched public key and currency as needed
                console.log("Public Key:", publicKey);
                console.log("Currency:", currency);

                // Replace the hardcoded public key with the fetched one
                let handler = PaystackPop.setup({
                    key: publicKey, // Use the fetched public key
                    email: email,
                    amount: (parseInt(amount) * 100),
                    reference: '' + Math.floor((Math.random() * 1000000000) + 1), // generates a pseudo-unique reference. Please replace with a reference you generated. Or remove the line entirely so Paystack API will generate one for you
                    // label: "Optional string that replaces customer email"
                    currency: currency, // Use the fetched currency
                    onClose: function() {

                    console.log("Payment window closed. Please try again later.");
                    return;

                    },
                    callback: function(response) {

                    let reference = response.reference;
                    // Send the payment reference to your server for verification
                    verifyPayment(reference, email, amount);
                    }
                });

                handler.openIframe();
                })
                .catch((error) => {
                // Handle any errors that occurred during the fetch or response processing
                console.error("Error while fetching public key:", error);
                // ... (rest of the error handling code)
                });
            }


            
    // Function to verify the payment on the server-side
    function verifyPayment(reference, email, total_amount) {
      const data = {
        reference: reference,
        email: email,
        total_amount: total_amount,
      };

      fetch("backend/paystack_callback.php", {
          method: "POST",
          body: JSON.stringify(data), // Convert data to JSON format
        })
        .then(response => response.json())
        .then(responseData => {
          // Process the response from the server after payment verification
          console.log("Payment verification response:", responseData);
          if (responseData.success == true) {

            updaterecords();
            
          } else {
            console.log("Payment failed. Please try again later.");
           
            return;
          }
        })
        .catch(error => {
          console.log("An error occurred while verifying payment. Please try again later.");
          return;
        });
    }

            function updaterecords(){
                alert('payment was successful');
            }
        });
    </script>
</body>
</html>
